# Servidor
from flask import Flask, render_template, request
from flask_socketio import SocketIO, emit
import subprocess
import threading

app = Flask(__name__)
socketio = SocketIO(app)

def run_command(directory, extension, output, quarantine, sid):
    command = ["python3", "/home/alberto/malware_finder/malware_finder.py", "-d", directory, "-e", extension, "-f", output]
    if quarantine:
        command.append('-q')
    process = subprocess.Popen(command, stdout=subprocess.PIPE, shell=False)
    while True:
        output = process.stdout.readline()
        if output == '' and process.poll() is not None:
            break
        if output:
            print(output.strip())
            socketio.emit('scan_result', {'data': output.strip().decode("utf-8") + '\n'}, room=sid)
    rc = process.poll()
    socketio.emit('scan_finished', {}, room=sid) # Emitimos el evento al finalizar el escaneo

@socketio.on('scan')
def handle_scan(message):
    print('received directory: ' + message['directory'])
    print('received extension: ' + message['extension'])
    print('received output file name: ' + message['output'])
    print('received quarantine mode: ' + str(message['quarantine']))
    threading.Thread(target=run_command, args=(message['directory'], message['extension'], message['output'], message['quarantine'], request.sid)).start()    

@app.route('/')
def index():
    return render_template('index.html')

if __name__ == '__main__':
    socketio.run(app)
